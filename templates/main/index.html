{% extends 'base.html' %}

{% block styles %}
<style>
    .file-icon {
        font-size: 2rem;
    }
    .folder-icon {
        color: #f0ad4e;
    }
    .file-card:hover {
        background-color: #f8f9fa;
    }
    .dropzone {
        border: 2px dashed #6c757d;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        color: #6c757d;
        margin-bottom: 2rem;
    }
    .dropzone.dragover {
        background-color: #f1f3f5;
        border-color: #0d6efd;
        color: #0d6efd;
    }
    a.card-link {
        text-decoration: none;
        color: inherit;
    }
</style>
{% endblock %}


{% block content %}
    {% include 'navigation.html' %}

    <div class="container my-2">

        <!-- Upload and New Folder Bar -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Root</a></li>
                    {% if path %}
                        <li class="breadcrumb-item active" aria-current="page">{{ path }}</li>
                    {% endif %}
                </ol>
            </nav>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                <i class="bi bi-folder-plus me-1"></i> –ù–æ–≤–∞—è –ø–∞–ø–∫–∞
            </button>
        </div>


        <div id="dropzone" class="dropzone">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã (–Ω–µ –±–æ–ª–µ–µ 10–ú–ë) –∏–ª–∏
            <label class="text-primary" style="cursor:pointer;">
                <u>–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</u>
                <input type="file" multiple hidden id="fileInput">
            </label>
        </div>
        <div id="uploadProgressList" class="mb-4"></div>


        <!-- Folder and File Grid -->
        <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-4">
            {% for entry in entries | default(value=[]) %}

                {% if entry.is_directory %}
                    <!-- Folder -->
                    <div class="col">
                        <a href="/?path={{path | urlencode}}/{{entry.name | urlencode}}" class="card-link">
                        <div class="card file-card text-center p-3 h-100 d-flex flex-column justify-content-center">
                            <div class="file-icon folder-icon mb-2">üìÅ</div>
                            <div>{{entry.name}}</div>
                        </div>
                        </a>
                    </div>
                {% else %}
                    <!-- File -->
                    <div class="col">
                        <a href="/upload/{{current_user.hub_id}}/{{entry.name | urlencode}}" class="card-link" download>
                        <div class="card file-card text-center p-3 h-100 d-flex flex-column justify-content-center">
                            {% if entry.is_image %}
                                <img src="/upload/{{current_user.hub_id}}/{{entry.name | urlencode}}" class="img-fluid rounded mb-2" style="max-height: 120px; object-fit: cover;" alt="preview" />
                            {% else %}
                                <div class="file-icon mb-2">üìÑ</div>
                            {% endif %}
                            <div>{{entry.name}}</div>
                        </div>
                        </a>
                    </div>
                {% endif %}

            {% endfor %}
        </div>
    </div>

    <!-- New Folder Modal -->
    <div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="newFolderForm" class="modal-content" action="/folder/create?path={{path | urlencode}}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="newFolderModalLabel">–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—É—é –ü–∞–ø–∫—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="folderName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="folderName" name="name" required />
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}

    <script>
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("fileInput");

        dropzone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropzone.classList.add("dragover");
        });

        dropzone.addEventListener("dragleave", () => {
            dropzone.classList.remove("dragover");
        });

        dropzone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropzone.classList.remove("dragover");
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener("change", (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            const uploadList = document.getElementById("uploadProgressList");
            uploadList.innerHTML = "";
            let completed = 0;
            dropzone.classList.add("d-none");
            fileInput.disabled = true;

            for (const file of files) {
                const formData = new FormData();
                formData.append("file", file);

                const id = "upload_" + Math.random().toString(36).slice(2, 10);
                uploadList.insertAdjacentHTML("beforeend", `
                <div class="mb-2" id="${id}_wrapper">
                    <div class="small mb-1">Uploading: ${file.name}</div>
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>
                `);

                fetch("/files/upload?path={{path | urlencode}}", {
                    method: "POST",
                    body: formData
                })
                .then(res => {
                    if (!res.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${file.name}.`);
                    return res.text();
                })
                .then(() => {
                    document.getElementById(`${id}_wrapper`).innerHTML = `
                    ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω: <strong>${file.name}</strong>
                    `;
                })
                .catch(err => {
                    document.getElementById(`${id}_wrapper`).innerHTML = `
                    ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ <strong>${file.name}</strong>: ${err.message}
                    `;
                })
                .finally(() => {
                    completed++;
                    if (completed === files.length) {
                        // All files uploaded
                        setTimeout(() => location.reload(), 1500);
                    }
                });
            }
        }
    </script>

{% endblock %}
